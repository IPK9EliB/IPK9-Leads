<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Israel Protection K9 Qualified Lead Manager</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSXNyYWVsIFByb3RlY3Rpb24gSzkgLSBRdWFsaWZpZWQgTGVhZHMiLCJzaG9ydF9uYW1lIjoiSVBLOSBMZWFkcyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMWUyOTNiIiwidGhlbWVfY29sb3IiOiIjM2I4MmY2In0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }

        .leads-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lead-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .lead-card:hover {
            transform: translateX(5px);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .lead-card.overdue {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.05);
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lead-name {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .lead-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-upcoming {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .lead-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: #f1f5f9;
            font-size: 14px;
        }

        .lead-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-item-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-item-name {
            font-weight: 600;
        }

        .user-item-role {
            font-size: 12px;
            color: #94a3b8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f1f5f9;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .sync-status.syncing {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .sync-status.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        .filter-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: transparent;
        }

        .badge-won {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .badge-lost {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-active {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .lead-card.closed-won {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.03);
        }

        .lead-card.closed-lost {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.03);
            opacity: 0.8;
        }

        .close-reason {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 13px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêï Israel Protection K9 - Qualified Leads</h1>
            <div class="user-info">
                <div class="user-badge" id="currentUserBadge">Eli (Admin)</div>
                <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('leads')">üìã Active Leads</button>
            <button class="tab" onclick="switchTab('overdue')">‚ö†Ô∏è Overdue</button>
            <button class="tab" onclick="switchTab('closed')">‚úÖ Closed</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalLeads">0</div>
                    <div class="stat-label">Active Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdueLeads">0</div>
                    <div class="stat-label">Overdue Follow-ups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="upcomingLeads">0</div>
                    <div class="stat-label">Upcoming This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="closedWonLeads" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0</div>
                    <div class="stat-label">Closed Won</div>
                </div>
            </div>

            <div class="leads-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Recent Activity</h2>
                    <button class="btn" onclick="showAddLeadModal()">‚ûï Add Lead</button>
                </div>
                <div id="recentLeads"></div>
            </div>
        </div>

        <!-- Active Leads Tab -->
        <div id="leads" class="tab-content">
            <div class="leads-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Active Leads</h2>
                    <button class="btn" onclick="showAddLeadModal()">‚ûï Add Lead</button>
                </div>
                <div id="allLeads"></div>
            </div>
        </div>

        <!-- Overdue Tab -->
        <div id="overdue" class="tab-content">
            <div class="leads-container">
                <h2 style="margin-bottom: 20px;">Overdue Follow-ups</h2>
                <div id="overdueLeadsList"></div>
            </div>
        </div>

        <!-- Closed Tab -->
        <div id="closed" class="tab-content">
            <div class="leads-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Closed Leads</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary filter-btn active" onclick="filterClosed('all')">All</button>
                        <button class="btn btn-secondary filter-btn" onclick="filterClosed('won')">üèÜ Won</button>
                        <button class="btn btn-secondary filter-btn" onclick="filterClosed('lost')">‚ùå Lost</button>
                    </div>
                </div>
                <div id="closedLeadsList"></div>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Lead</h2>
                <button class="close-btn" onclick="closeModal('addLeadModal')">&times;</button>
            </div>
            <form onsubmit="addLead(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="leadName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="leadEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="leadPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Dog Type/Breed</label>
                    <input type="text" class="form-input" id="leadDog">
                </div>
                <div class="form-group">
                    <label class="form-label">Lifestyle Details</label>
                    <textarea class="form-textarea" id="leadLifestyle"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget</label>
                    <input type="text" class="form-input" id="leadBudget">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="leadNotes"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Lead Source *</label>
                    <select class="form-select" id="leadSource" required>
                        <option value="unknown">Unknown</option>
                        <option value="ppc">PPC (Google Ads)</option>
                        <option value="seo">SEO (Organic)</option>
                        <option value="meta">Meta (Facebook/Instagram)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Interval *</label>
                    <select class="form-select" id="leadInterval" required>
                        <option value="2weeks">2 Weeks</option>
                        <option value="1month">1 Month</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Add Lead</button>
            </form>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div id="editLeadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Lead</h2>
                <button class="close-btn" onclick="closeModal('editLeadModal')">&times;</button>
            </div>
            <form onsubmit="updateLead(event)">
                <input type="hidden" id="editLeadId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="editLeadName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="editLeadEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="editLeadPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Dog Type/Breed</label>
                    <input type="text" class="form-input" id="editLeadDog">
                </div>
                <div class="form-group">
                    <label class="form-label">Lifestyle Details</label>
                    <textarea class="form-textarea" id="editLeadLifestyle"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Budget</label>
                    <input type="text" class="form-input" id="editLeadBudget">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="editLeadNotes"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Lead Source</label>
                    <select class="form-select" id="editLeadSource">
                        <option value="unknown">Unknown</option>
                        <option value="ppc">PPC (Google Ads)</option>
                        <option value="seo">SEO (Organic)</option>
                        <option value="meta">Meta (Facebook/Instagram)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Follow-up Interval *</label>
                    <select class="form-select" id="editLeadInterval" required>
                        <option value="2weeks">2 Weeks</option>
                        <option value="1month">1 Month</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Next Follow-up Date</label>
                    <input type="date" class="form-input" id="editLeadFollowupDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Lead Status</label>
                    <select class="form-select" id="editLeadStatus">
                        <option value="active">üîµ Active</option>
                        <option value="won">üèÜ Closed - Won</option>
                        <option value="lost">‚ùå Closed - Lost</option>
                    </select>
                </div>
                <div class="form-group" id="closeReasonGroup" style="display: none;">
                    <label class="form-label">Close Reason/Notes</label>
                    <textarea class="form-textarea" id="editLeadCloseReason" placeholder="Why did this lead close?"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">Update Lead</button>
                    <button type="button" class="btn btn-danger" onclick="deleteLead()" style="flex: 1;">Delete Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Team Member</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form onsubmit="addUser(event)">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-input" id="userName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select class="form-select" id="userRole" required>
                        <option value="viewer">Viewer (Read-only)</option>
                        <option value="editor">Editor (Can add/edit leads)</option>
                        <option value="admin">Admin (Full access)</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Add User</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">HubSpot Integration (Read-Only)</h3>
                
                <div id="syncStatus" class="sync-status" style="display: none;">
                    ‚úÖ Last synced: Never
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" class="form-input" id="hubspotApiKey" placeholder="Enter HubSpot API key">
                    <p style="margin-top: 10px; font-size: 12px; color: #94a3b8;">
                        ‚úÖ Read-only access - will ONLY import qualified leads<br>
                        ‚úÖ Will NOT modify or touch any HubSpot data or settings
                    </p>
                </div>
                <button class="btn" onclick="saveHubSpotKey()">Save API Key</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()" style="width: auto;">
                        <span class="form-label" style="margin: 0;">Enable Auto-Sync</span>
                    </label>
                    <p style="margin-top: 8px; font-size: 12px; color: #94a3b8;">
                        Automatically import new qualified leads from HubSpot
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sync Frequency</label>
                    <select class="form-select" id="syncFrequency" onchange="updateSyncFrequency()">
                        <option value="15">Every 15 minutes</option>
                        <option value="30" selected>Every 30 minutes</option>
                        <option value="60">Every hour</option>
                        <option value="120">Every 2 hours</option>
                        <option value="240">Every 4 hours</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="syncHubSpot(false)">üîÑ Sync Now</button>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">Google Calendar</h3>
                <div class="form-group">
                    <label class="form-label">Calendar Integration</label>
                    <button class="btn" onclick="connectGoogleCalendar()">Connect Google Calendar</button>
                    <p style="margin-top: 10px; font-size: 12px; color: #94a3b8;">Click to authorize calendar access for automatic task creation</p>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">Team Members</h3>
                <div id="usersList" class="user-list" style="margin-bottom: 15px;"></div>
                <button class="btn" onclick="showAddUserModal()">‚ûï Add User</button>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">Data Management</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportData()">Export All Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = { name: 'Eli', email: 'eli@israelprotectionk9.com', role: 'admin' };
        let leads = [];
        let users = [currentUser];
        let calendarToken = null;
        let autoSyncInterval = null;
        let lastSyncTime = null;
        let closedFilter = 'all';

        // Initialize app
        async function init() {
            await loadData();
            loadSettings();
            renderDashboard();
            renderAllLeads();
            renderOverdueLeads();
            renderClosedLeads();
            renderUsers();
            updateStats();
            startAutoSync();
            
            // Add status change listener for edit modal
            document.getElementById('editLeadStatus').addEventListener('change', function() {
                const closeReasonGroup = document.getElementById('closeReasonGroup');
                closeReasonGroup.style.display = this.value !== 'active' ? 'block' : 'none';
            });
        }

        // Storage functions
        async function loadData() {
            try {
                const leadsData = await window.storage.get('ipk9-leads', true);
                const usersData = await window.storage.get('ipk9-users', true);
                
                if (leadsData) leads = JSON.parse(leadsData.value);
                if (usersData) users = JSON.parse(usersData.value);
            } catch (error) {
                console.log('No existing data found, starting fresh');
            }
        }

        async function saveData() {
            try {
                await window.storage.set('ipk9-leads', JSON.stringify(leads), true);
                await window.storage.set('ipk9-users', JSON.stringify(users), true);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadSettings() {
            const apiKey = localStorage.getItem('hubspot-api-key');
            if (apiKey) {
                document.getElementById('hubspotApiKey').value = apiKey;
            }
            
            // Auto-sync is ALWAYS enabled by default
            let autoSync = localStorage.getItem('hubspot-auto-sync');
            if (autoSync === null) {
                // First time - enable auto-sync by default
                localStorage.setItem('hubspot-auto-sync', 'true');
                autoSync = 'true';
            }
            document.getElementById('autoSyncEnabled').checked = autoSync === 'true';
            
            const syncFreq = localStorage.getItem('hubspot-sync-frequency') || '30';
            document.getElementById('syncFrequency').value = syncFreq;
            
            lastSyncTime = localStorage.getItem('last-sync-time');
            if (lastSyncTime) {
                updateSyncStatus();
            }
            
            calendarToken = localStorage.getItem('google-calendar-token');
        }

        function saveHubSpotKey() {
            const apiKey = document.getElementById('hubspotApiKey').value;
            localStorage.setItem('hubspot-api-key', apiKey);
            alert('HubSpot API key saved!');
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'overdue') renderOverdueLeads();
            if (tabName === 'leads') renderAllLeads();
            if (tabName === 'closed') renderClosedLeads();
        }

        // Modal functions
        function showAddLeadModal() {
            document.getElementById('addLeadModal').classList.add('active');
        }

        function showSettings() {
            renderUsers();
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddUserModal() {
            if (currentUser.role !== 'admin') {
                alert('Only admins can add users');
                return;
            }
            document.getElementById('addUserModal').classList.add('active');
        }

        // Lead functions
        async function addLead(event) {
            event.preventDefault();
            
            const newLead = {
                id: 'lead_' + Date.now(),
                name: document.getElementById('leadName').value,
                email: document.getElementById('leadEmail').value,
                phone: document.getElementById('leadPhone').value,
                dog: document.getElementById('leadDog').value,
                lifestyle: document.getElementById('leadLifestyle').value,
                budget: document.getElementById('leadBudget').value,
                notes: document.getElementById('leadNotes').value,
                leadSource: document.getElementById('leadSource').value,
                interval: document.getElementById('leadInterval').value,
                createdDate: new Date().toISOString(),
                nextFollowup: calculateNextFollowup(document.getElementById('leadInterval').value),
                assignedTo: currentUser.name,
                source: 'manual',
                status: 'active'
            };

            leads.push(newLead);
            await saveData();
            await createCalendarEvent(newLead);
            
            closeModal('addLeadModal');
            event.target.reset();
            
            renderDashboard();
            renderAllLeads();
            updateStats();
            
            alert('Lead added successfully!');
        }

        function calculateNextFollowup(interval) {
            const date = new Date();
            if (interval === '2weeks') {
                date.setDate(date.getDate() + 14);
            } else if (interval === '1month') {
                date.setMonth(date.getMonth() + 1);
            }
            return date.toISOString();
        }

        function editLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            document.getElementById('editLeadId').value = lead.id;
            document.getElementById('editLeadName').value = lead.name;
            document.getElementById('editLeadEmail').value = lead.email || '';
            document.getElementById('editLeadPhone').value = lead.phone || '';
            document.getElementById('editLeadDog').value = lead.dog || '';
            document.getElementById('editLeadLifestyle').value = lead.lifestyle || '';
            document.getElementById('editLeadBudget').value = lead.budget || '';
            document.getElementById('editLeadNotes').value = lead.notes || '';
            document.getElementById('editLeadSource').value = lead.leadSource || 'unknown';
            document.getElementById('editLeadInterval').value = lead.interval;
            document.getElementById('editLeadStatus').value = lead.status || 'active';
            document.getElementById('editLeadCloseReason').value = lead.closeReason || '';
            
            // Show/hide close reason based on status
            const closeReasonGroup = document.getElementById('closeReasonGroup');
            closeReasonGroup.style.display = (lead.status && lead.status !== 'active') ? 'block' : 'none';
            
            const followupDate = new Date(lead.nextFollowup);
            document.getElementById('editLeadFollowupDate').value = followupDate.toISOString().split('T')[0];

            document.getElementById('editLeadModal').classList.add('active');
        }

        async function updateLead(event) {
            event.preventDefault();
            
            const leadId = document.getElementById('editLeadId').value;
            const leadIndex = leads.findIndex(l => l.id === leadId);
            
            if (leadIndex === -1) return;

            const followupDate = document.getElementById('editLeadFollowupDate').value;
            const newStatus = document.getElementById('editLeadStatus').value;
            const oldStatus = leads[leadIndex].status || 'active';
            
            leads[leadIndex] = {
                ...leads[leadIndex],
                name: document.getElementById('editLeadName').value,
                email: document.getElementById('editLeadEmail').value,
                phone: document.getElementById('editLeadPhone').value,
                dog: document.getElementById('editLeadDog').value,
                lifestyle: document.getElementById('editLeadLifestyle').value,
                budget: document.getElementById('editLeadBudget').value,
                notes: document.getElementById('editLeadNotes').value,
                leadSource: document.getElementById('editLeadSource').value,
                interval: document.getElementById('editLeadInterval').value,
                nextFollowup: followupDate ? new Date(followupDate).toISOString() : leads[leadIndex].nextFollowup,
                status: newStatus,
                closeReason: document.getElementById('editLeadCloseReason').value,
                closedDate: (newStatus !== 'active' && oldStatus === 'active') ? new Date().toISOString() : leads[leadIndex].closedDate
            };

            await saveData();
            await createCalendarEvent(leads[leadIndex]);
            
            closeModal('editLeadModal');
            renderDashboard();
            renderAllLeads();
            renderOverdueLeads();
            renderClosedLeads();
            updateStats();
            
            alert('Lead updated successfully!');
        }

        async function deleteLead() {
            if (!confirm('Are you sure you want to delete this lead?')) return;
            
            const leadId = document.getElementById('editLeadId').value;
            leads = leads.filter(l => l.id !== leadId);
            
            await saveData();
            closeModal('editLeadModal');
            
            renderDashboard();
            renderAllLeads();
            renderOverdueLeads();
            updateStats();
            
            alert('Lead deleted successfully!');
        }

        // User functions
        async function addUser(event) {
            event.preventDefault();
            
            const newUser = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value
            };

            users.push(newUser);
            await saveData();
            
            closeModal('addUserModal');
            event.target.reset();
            renderUsers();
            updateStats();
            
            alert('User added successfully!');
        }

        async function deleteUser(email) {
            if (email === currentUser.email) {
                alert('Cannot delete yourself!');
                return;
            }
            
            if (!confirm('Are you sure you want to remove this user?')) return;
            
            users = users.filter(u => u.email !== email);
            await saveData();
            renderUsers();
            updateStats();
        }

        // HubSpot sync - Uses public CORS proxy (no server needed)
        async function syncHubSpot(isAutomatic = false) {
            const apiKey = localStorage.getItem('hubspot-api-key');
            if (!apiKey) {
                if (!isAutomatic) {
                    alert('Please set your HubSpot API key in settings first');
                }
                return;
            }

            if (!isAutomatic) {
                showSyncStatus('syncing', 'Syncing with HubSpot...');
            }

            try {
                // Use corsproxy.io to bypass CORS (free, no setup needed)
                const hubspotEndpoint = 'https://api.hubapi.com/crm/v3/objects/contacts/search';
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(hubspotEndpoint)}`;
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filterGroups: [{
                            filters: [{
                                propertyName: 'hs_lead_status',
                                operator: 'EQ',
                                value: 'CONNECTED'
                            }]
                        }],
                        properties: ['firstname', 'lastname', 'email', 'phone', 'mobilephone', 'lifecyclestage', 'hs_lead_status', 'company', 'createdate'],
                        limit: 100
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HubSpot API error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                const qualifiedContacts = data.results || [];
                console.log(`Found ${qualifiedContacts.length} "Connected" leads from HubSpot`);

                // Transform HubSpot contacts to app lead format
                const existingHubSpotIds = leads
                    .filter(l => l.hubspotId)
                    .map(l => l.hubspotId);

                let newLeadsCount = 0;

                for (const contact of qualifiedContacts) {
                    if (existingHubSpotIds.includes(contact.id)) {
                        continue;
                    }

                    const props = contact.properties;
                    const newLead = {
                        id: `hubspot_${contact.id}`,
                        hubspotId: contact.id,
                        name: `${props.firstname || ''} ${props.lastname || ''}`.trim() || 'Unknown',
                        email: props.email || '',
                        phone: props.phone || props.mobilephone || '',
                        dog: '',
                        lifestyle: '',
                        budget: '',
                        notes: `Imported from HubSpot\nCompany: ${props.company || 'N/A'}`,
                        interval: '2weeks',
                        createdDate: props.createdate || new Date().toISOString(),
                        nextFollowup: calculateNextFollowup('2weeks'),
                        assignedTo: 'Eli',
                        source: 'hubspot',
                        status: 'active',
                        lastSyncedFromHubSpot: new Date().toISOString()
                    };

                    leads.push(newLead);
                    newLeadsCount++;

                    await createCalendarEvent(newLead);
                }

                lastSyncTime = new Date().toISOString();
                localStorage.setItem('last-sync-time', lastSyncTime);

                await saveData();
                
                if (!isAutomatic) {
                    showSyncStatus('success', `Synced ${newLeadsCount} new leads`);
                    if (newLeadsCount > 0) {
                        alert(`‚úÖ HubSpot sync complete!\n\n${newLeadsCount} new qualified leads imported\nTotal active leads: ${leads.filter(l => !l.status || l.status === 'active').length}`);
                    } else {
                        alert(`‚úÖ HubSpot sync complete!\n\nNo new leads found\nTotal active leads: ${leads.filter(l => !l.status || l.status === 'active').length}`);
                    }
                } else {
                    if (newLeadsCount > 0) {
                        console.log(`‚úÖ Auto-sync: ${newLeadsCount} new leads imported`);
                        showSyncStatus('success', `Auto-synced ${newLeadsCount} new leads`);
                    }
                }
                
                renderDashboard();
                renderAllLeads();
                renderOverdueLeads();
                renderClosedLeads();
                updateStats();
                
            } catch (error) {
                console.error('HubSpot sync error:', error);
                
                if (!isAutomatic) {
                    showSyncStatus('error', 'Sync failed');
                    alert(`‚ùå HubSpot sync failed\n\nError: ${error.message}\n\nPlease check:\n- Your HubSpot API key is correct\n- You have API access permissions\n- The key has contacts.read scope`);
                }
            }
        }

        function startAutoSync() {
            const enabled = localStorage.getItem('hubspot-auto-sync') === 'true';
            const frequency = parseInt(localStorage.getItem('hubspot-sync-frequency') || '30');
            
            // Clear existing interval
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            if (enabled) {
                // Run initial sync
                syncHubSpot(true);
                
                // Set up recurring sync
                autoSyncInterval = setInterval(() => {
                    syncHubSpot(true);
                }, frequency * 60 * 1000); // Convert minutes to milliseconds
                
                console.log(`Auto-sync enabled: every ${frequency} minutes`);
            }
        }

        function toggleAutoSync() {
            const enabled = document.getElementById('autoSyncEnabled').checked;
            localStorage.setItem('hubspot-auto-sync', enabled);
            startAutoSync();
            
            if (enabled) {
                alert('‚úÖ Auto-sync enabled! Qualified leads will be automatically imported from HubSpot.');
            } else {
                alert('Auto-sync disabled. You can still manually sync anytime.');
            }
        }

        function updateSyncFrequency() {
            const frequency = document.getElementById('syncFrequency').value;
            localStorage.setItem('hubspot-sync-frequency', frequency);
            
            // Restart auto-sync with new frequency
            if (localStorage.getItem('hubspot-auto-sync') === 'true') {
                startAutoSync();
            }
        }

        function showSyncStatus(type, message) {
            const statusDiv = document.getElementById('syncStatus');
            if (!statusDiv) return;
            
            statusDiv.className = `sync-status ${type}`;
            statusDiv.innerHTML = `
                ${type === 'syncing' ? '<span class="spinning">üîÑ</span>' : type === 'success' ? '‚úÖ' : '‚ùå'}
                ${message}
            `;
            statusDiv.style.display = 'flex';
        }

        function updateSyncStatus() {
            if (!lastSyncTime) return;
            const statusDiv = document.getElementById('syncStatus');
            if (!statusDiv) return;
            
            const lastSync = new Date(lastSyncTime);
            const now = new Date();
            const minutesAgo = Math.floor((now - lastSync) / 60000);
            
            let timeText;
            if (minutesAgo < 1) {
                timeText = 'Just now';
            } else if (minutesAgo < 60) {
                timeText = `${minutesAgo} min ago`;
            } else {
                const hoursAgo = Math.floor(minutesAgo / 60);
                timeText = `${hoursAgo} hr ago`;
            }
            
            statusDiv.className = 'sync-status';
            statusDiv.innerHTML = `‚úÖ Last synced: ${timeText}`;
            statusDiv.style.display = 'flex';
        }

        // Google Calendar integration
        async function connectGoogleCalendar() {
            alert('Google Calendar integration requires OAuth setup.\n\nFor now, calendar events will be shown here. You can manually add them to your Google Calendar, or tell Claude to create calendar events for specific follow-ups.');
            calendarToken = 'demo-token';
            localStorage.setItem('google-calendar-token', calendarToken);
        }

        async function createCalendarEvent(lead) {
            if (!calendarToken) return;

            const eventDetails = {
                summary: `Follow up: ${lead.name}`,
                description: `Dog: ${lead.dog}\nBudget: ${lead.budget}\nNotes: ${lead.notes}`,
                start: new Date(lead.nextFollowup),
                lead: lead
            };

            console.log('Calendar event created:', eventDetails);
            // In production, this would call Google Calendar API
        }

        // Render functions
        function renderDashboard() {
            const recent = leads.slice(-5).reverse();
            const container = document.getElementById('recentLeads');
            
            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No leads yet. Add your first qualified lead!</p></div>';
                return;
            }

            container.innerHTML = recent.map(lead => renderLeadCard(lead)).join('');
        }

        function renderAllLeads() {
            const container = document.getElementById('allLeads');
            const activeLeads = leads.filter(l => !l.status || l.status === 'active');
            
            if (activeLeads.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No active leads. Add a new lead or sync from HubSpot.</p></div>';
                return;
            }

            container.innerHTML = activeLeads.map(lead => renderLeadCard(lead)).join('');
        }

        function renderOverdueLeads() {
            const now = new Date();
            const overdue = leads.filter(lead => {
                const isActive = !lead.status || lead.status === 'active';
                return isActive && new Date(lead.nextFollowup) < now;
            });
            const container = document.getElementById('overdueLeadsList');
            
            if (overdue.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No overdue follow-ups! You\'re all caught up.</p></div>';
                return;
            }

            container.innerHTML = overdue.map(lead => renderLeadCard(lead)).join('');
        }

        function renderClosedLeads() {
            const container = document.getElementById('closedLeadsList');
            let closedLeads = leads.filter(l => l.status === 'won' || l.status === 'lost');
            
            // Apply filter
            if (closedFilter === 'won') {
                closedLeads = closedLeads.filter(l => l.status === 'won');
            } else if (closedFilter === 'lost') {
                closedLeads = closedLeads.filter(l => l.status === 'lost');
            }
            
            // Sort by closed date, most recent first
            closedLeads.sort((a, b) => new Date(b.closedDate || 0) - new Date(a.closedDate || 0));
            
            if (closedLeads.length === 0) {
                const filterText = closedFilter === 'all' ? 'closed' : closedFilter;
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No ${filterText} leads yet.</p></div>`;
                return;
            }

            container.innerHTML = closedLeads.map(lead => renderLeadCard(lead, true)).join('');
        }

        function filterClosed(filter) {
            closedFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderClosedLeads();
        }

        function renderLeadCard(lead) {
            const now = new Date();
            const followupDate = new Date(lead.nextFollowup);
            const isOverdue = followupDate < now;
            const daysUntil = Math.ceil((followupDate - now) / (1000 * 60 * 60 * 24));
            const status = lead.status || 'active';
            const isClosed = status === 'won' || status === 'lost';
            
            // Determine card class
            let cardClass = 'lead-card';
            if (isClosed) {
                cardClass += status === 'won' ? ' closed-won' : ' closed-lost';
            } else if (isOverdue) {
                cardClass += ' overdue';
            }
            
            // Determine badge
            let badgeHtml = '';
            if (isClosed) {
                if (status === 'won') {
                    badgeHtml = '<div class="lead-badge badge-won">üèÜ Won</div>';
                } else {
                    badgeHtml = '<div class="lead-badge badge-lost">‚ùå Lost</div>';
                }
            } else if (isOverdue) {
                badgeHtml = '<div class="lead-badge badge-overdue">‚ö†Ô∏è Overdue</div>';
            } else {
                badgeHtml = `<div class="lead-badge badge-upcoming">üìÖ ${daysUntil} days</div>`;
            }

            return `
                <div class="${cardClass}">
                    <div class="lead-header">
                        <div class="lead-name">${lead.name}</div>
                        ${badgeHtml}
                    </div>
                    <div class="lead-details">
                        <div class="detail-item">
                            <div class="detail-label">Dog Type</div>
                            <div class="detail-value">${lead.dog || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Budget</div>
                            <div class="detail-value">${lead.budget || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">${isClosed ? 'Closed Date' : 'Next Follow-up'}</div>
                            <div class="detail-value">${isClosed && lead.closedDate ? new Date(lead.closedDate).toLocaleDateString() : followupDate.toLocaleDateString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Lead Source</div>
                            <div class="detail-value">${formatLeadSource(lead.leadSource)}</div>
                        </div>
                    </div>
                    ${lead.lifestyle ? `
                    <div class="detail-item" style="margin-top: 10px;">
                        <div class="detail-label">Lifestyle</div>
                        <div class="detail-value">${lead.lifestyle}</div>
                    </div>
                    ` : ''}
                    ${lead.notes ? `
                    <div class="detail-item" style="margin-top: 10px;">
                        <div class="detail-label">Notes</div>
                        <div class="detail-value">${lead.notes}</div>
                    </div>
                    ` : ''}
                    ${isClosed && lead.closeReason ? `
                    <div class="close-reason">
                        <strong>Close Reason:</strong> ${lead.closeReason}
                    </div>
                    ` : ''}
                    <div class="lead-actions">
                        <button class="btn btn-small" onclick="editLead('${lead.id}')">‚úèÔ∏è Edit</button>
                        ${lead.email ? `<button class="btn btn-secondary btn-small" onclick="window.location.href='mailto:${lead.email}'">üìß Email</button>` : ''}
                        ${lead.phone ? `<button class="btn btn-secondary btn-small" onclick="window.location.href='tel:${lead.phone}'">üìû Call</button>` : ''}
                    </div>
                </div>
            `;
        }

        function formatLeadSource(source) {
            const sources = {
                'ppc': 'üéØ PPC (Google Ads)',
                'seo': 'üîç SEO (Organic)',
                'meta': 'üì± Meta (FB/IG)',
                'unknown': '‚ùì Unknown',
                'hubspot': 'üîÑ HubSpot'
            };
            return sources[source] || sources['unknown'];
        }

        function renderUsers() {
            const container = document.getElementById('usersList');
            
            container.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-item-info">
                        <div class="user-item-name">${user.name}</div>
                        <div class="user-item-role">${user.email} ‚Ä¢ ${user.role.toUpperCase()}</div>
                    </div>
                    ${currentUser.role === 'admin' && user.email !== currentUser.email ? 
                        `<button class="btn btn-danger btn-small" onclick="deleteUser('${user.email}')">Remove</button>` 
                        : ''}
                </div>
            `).join('');
        }

        function updateStats() {
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const activeLeads = leads.filter(l => !l.status || l.status === 'active');
            
            document.getElementById('totalLeads').textContent = activeLeads.length;
            document.getElementById('overdueLeads').textContent = activeLeads.filter(l => new Date(l.nextFollowup) < now).length;
            document.getElementById('upcomingLeads').textContent = activeLeads.filter(l => {
                const followup = new Date(l.nextFollowup);
                return followup >= now && followup <= weekFromNow;
            }).length;
            document.getElementById('closedWonLeads').textContent = leads.filter(l => l.status === 'won').length;
        }

        // Data management
        function exportData() {
            const data = {
                leads,
                users,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ipk9-leads-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        async function clearAllData() {
            if (!confirm('Are you sure? This will delete ALL leads and users (except you). This cannot be undone!')) return;
            
            leads = [];
            users = [currentUser];
            
            await saveData();
            
            renderDashboard();
            renderAllLeads();
            renderOverdueLeads();
            renderUsers();
            updateStats();
            
            alert('All data cleared!');
        }

        // Initialize on load
        window.addEventListener('load', init);
        
        // Update sync status every minute
        setInterval(updateSyncStatus, 60000);

        // Install as PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</body>
</html>
